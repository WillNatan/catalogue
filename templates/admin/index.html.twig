{% extends 'admin/base.html.twig' %}

{% block title %}Dashboard{% endblock %}

{% block css %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css">
    <link rel="stylesheet" href="{{ asset('dashboard/css/datatablesRowOrder.css') }}">
    <link rel="stylesheet" href="{{ asset('dashboard/css/datatablesResponsive.css') }}">
{% endblock %}
{% block body %}
    <h1 class="h1">Dashboard <span class="text-xs">Vue d'ensemble</span></h1>
    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="db-box gradient-1">
                <div class="db-box-body">
                    <div class="row no-gutters justify-content-between align-items-center pr-1">
                                   <div class="col-6">
                                        <span class="fa-stack fa-2x">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-calendar text-dark fa-stack-1x"></i>
                                    </span>
                                   </div>
                       <div class="col-6">
                           <a href="{{ path('Catalogue-des-rapports') }}">
                               <div class="text-xs font-weight-bold text-uppercase mb-1"><p class="m-0">Accéder au
                                       catalogue</p></div>
                           </a>
                       </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="db-box gradient-2">
                <div class="db-box-body">
                    <div class="row no-gutters justify-content-between align-items-center pr-1">
                                    <div class="col-6">
                                        <span class="fa-stack fa-2x">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-file text-dark fa-stack-1x"></i>
                                    </span>
                                    </div>
                        <div class="col-6">
                            <div class=" font-weight-bold text-uppercase mb-1">
                                <p class="text-xs m-0 text-right">Nombre de rapports</p>
                                <p class="text-gray-500 text-right m-0">{{ nbRapport }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="db-box gradient-3">
                <div class="db-box-body">
                    <div class="row no-gutters">
                        <div class="col-6">
                            <span class="fa-stack fa-2x">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-file-alt text-dark fa-stack-1x"></i>
                                    </span>
                        </div>
                        <div class="col-6">
                            <div class=" font-weight-bold text-uppercase mb-1">
                                <p class="text-xs m-0 text-right mb-1">
                                    Modif. rapports
                                </p>
                                <p class="text-gray-500 text-right m-0">{{ nbUpdate }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="db-box h-100 gradient-4">
                <div class="db-box-body">
                    <div class="row align-items-center">
                        <div class="col mr-2 text-center">
                            <div class="text-xs font-weight-bold text-uppercase mb-1"><p>Dernier rapport</p>
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-light row">
                                {% if lastReport %}
                                    <div class="col-5">
                                        <a class="text-xs"
                                           href="{{ path('Détails-rapport', {'id': lastReport.id}) }}">{{ lastReport.nomRapport }}</a>
                                    </div>
                                    <div class="col-7">
                                        <span class="text-xs">{{ lastReport.creationDate|date('d-m-Y') }}</span>
                                    </div>
                                {% else %}
                                    <div class="col-12">
                                        <p class="text-light">Aucun résultat</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-12 mb-4">
            <div class="row">
                <div class="col-12 col-lg-6">
                    <div class="db-box bg-darker">
                        <div class="db-box-body">
                            <div class="row align-items-center">
                                <div class="col mr-2 text-center">
                                    <div class="text-xs font-weight-bold text-orange text-uppercase mb-1"><p>Nombre de
                                            rapports par dossier</p></div>
                                    <hr>
                                    <div class="mb-0 text-gray-800">
                                        <canvas id="ReportsByFolders"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-6">
                    <div class="db-box bg-darker">
                        <div class="db-box-body">
                            <div class="row align-items-center">
                                <div class="col mr-2 text-center">
                                    <div class="text-xs font-weight-bold text-orange text-uppercase mb-1"><p>Nombre de
                                            rapports par utilisateur</p></div>
                                    <hr>
                                    <div class="mb-0 text-gray-800">
                                        <canvas id="ReportsByUsers"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 mb-4">
            <div class="row">
                <div class="col-12 col-lg-6">
                    <div class="db-box bg-darker">
                        <div class="db-box-body">
                            <div class="row align-items-center">
                                <div class="col mr-2 text-center">
                                    <div class="text-xs font-weight-bold text-orange text-uppercase mb-1"><p>Rapports en
                                            RECETTE/PRODUCTION</p></div>
                                    <hr>
                                    <div class="mb-0">
                                            <table class="mdl-data-table" style="width:100%" id="table-recette-production">
                                                <thead>
                                                <tr>
                                                    <th>Numéro de rapport</th>
                                                    <th>Nom du rapport</th>
                                                    <th>Version en RECETTE</th>
                                                    <th>Version en PRODUCTION</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                {% for recetteReport in recette %}
                                                    {% for prodReport in production %}
                                                        {% if prodReport.Nom_Rapport == recetteReport.Nom_Rapport %}
                                                            <tr>
                                                                <td>{{ recetteReport.n }}</td>
                                                                <td>{{ recetteReport.Nom_Rapport }}</td>
                                                                <td>
                                                                    <a href="{{ path('Détails-rapport', {'id': recetteReport.id}) }}">{{ recetteReport.VersionActuelle }}</a>
                                                                </td>
                                                                <td>
                                                                    <a href="{{ path('Détails-rapport', {'id': prodReport.id}) }}">{{ prodReport.VersionActuelle }}</a>
                                                                </td>
                                                            </tr>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endfor %}

                                                </tbody>
                                            </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-6">
                    <div class="db-box bg-darker">
                        <div class="db-box-body">
                            <div class="row align-items-center">
                                <div class="col mr-2 text-center">
                                    <div class="text-xs font-weight-bold text-orange text-uppercase mb-1"><p>Rapports en
                                            RECETTE</p></div>
                                    <hr>
                                    <div class="mb-0">
                                            <table class="mdl-data-table" style="width:100%" id="table-recette">
                                                <thead>
                                                <tr>
                                                    <th>Numéro de rapport</th>
                                                    <th>Nom du rapport</th>
                                                    <th>Date de création</th>
                                                    <th>Version</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                {% for recetteReport in recette %}
                                                    <tr>
                                                        <td>{{ recetteReport.n }}</td>
                                                        <td>{{ recetteReport.Nom_Rapport }}</td>
                                                        <td>{{ recetteReport.CreationDate|date('d-m-y') }}</td>
                                                        <td>
                                                            <a href="{{ path('Détails-rapport', {'id': recetteReport.id}) }}">{{ recetteReport.VersionActuelle }}</a>
                                                        </td>
                                                    </tr>
                                                {% endfor %}

                                                </tbody>
                                            </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
    <script src="{{ asset('dashboard/js/datatablesResponsive.js') }}"></script>
    <script src="{{ asset('dashboard/js/datatalesRowOrder.js') }}"></script>
    <script>
        $('#table-recette-production').dataTable({
            iDisplayLength: 5,
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.10.20/i18n/French.json"
            },
            responsive:true,
        });
        $('#table-recette').dataTable({
            iDisplayLength: 5,
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.10.20/i18n/French.json"
            },
            responsive:true,
        });
    </script>
    <script>
        let ctx = document.getElementById('ReportsByFolders');
        function random_rgba() {
            let o = Math.round, r = Math.random, s = 255;
            return 'rgba(' + o(r() * s) + ',' + o(r() * s) + ',' + o(r() * s) + ',' + r().toFixed(1) + ')';
        }
        gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, random_rgba());
        gradient.addColorStop(1, random_rgba());
        let myChart = new Chart(ctx, {

            type: 'bar',
            data: {
                labels: [
                    {% for report in reportsByFolder %}
                    '{{ report.nomDossier|raw }}'{% if loop.last %}{% else %},{% endif %}
                    {% endfor %}
                ],

                datasets: [{
                    label: 'Nombre de rapports',
                    data: [
                        {% for report in reportsByFolder %}
                        '{{ report.nombreRapport|raw }}'{% if loop.last %}{% else %},{% endif %}
                        {% endfor %}
                    ],

                    backgroundColor: [
                        {% for report in reportsByFolder %}
                        gradient{% if loop.last %}{% else %},{% endif %}
                        {% endfor %}
                    ],
                    hoverBackgroundColor: gradient,
                    hoverBorderWidth: 2,
                    hoverBorderColor: gradient,
                }]
            },
            options: {
                responsive: true,
                legend: {
                    labels: {
                        // This more specific font property overrides the global property
                        fontColor: 'white'
                    }
                }
                ,
                scales: {
                    yAxes: [{
                        ticks: {
                            fontColor: "white",
                        }
                    }],
                    xAxes: [{
                        ticks: {
                            fontColor: "white",
                        }
                    }]
                }
            }
        });



        let doughnut = document.getElementById('ReportsByUsers');
        dgradient = doughnut.getContext('2d').createLinearGradient(0, 0, 0, 400);
        dgradient.addColorStop(0, random_rgba());
        dgradient.addColorStop(1, random_rgba());

        let DoughnutChart = new Chart(doughnut, {
            type: 'doughnut',
            data: {
                labels: [
                    {% for report in reportByUser %}
                    '{{ report.username|raw }}'{% if loop.last %}{% else %},{% endif %}
                    {% endfor %}
                ],
                datasets: [{
                    label: 'Nombre de rapports',
                    data: [
                        {% for report in reportByUser %}
                        '{{ report.nombreRapport|raw }}'{% if loop.last %}{% else %},{% endif %}
                        {% endfor %}
                    ],
                    backgroundColor: [
                        {% for report in reportByUser %}
                        dgradient{% if loop.last %}{% else %},{% endif %}
                        {% endfor %}
                    ],
                    hoverBackgroundColor: dgradient,
                    hoverBorderWidth: 2,
                    hoverBorderColor: gradient
                }]
            },
            options: {
                responsive: true,
                legend: {
                    labels: {
                        // This more specific font property overrides the global property
                        fontColor: 'white'
                    }
                }
                ,
                scales: {
                    yAxes: [{
                        ticks: {
                            fontColor: "white",
                        }
                    }],
                    xAxes: [{
                        ticks: {
                            fontColor: "white",
                        }
                    }]
                }

            }
        });
    </script>
{% endblock %}